# 1 HashMap 基本原理

`HashMap` 是基于哈希表实现的集合，它采用了 **数组 + 链表 + 红黑树** 的形式来存储元素。在哈希表中，数组中的每一项被称为 **桶**，`HashMap` 存储元素时，会计算出元素的哈希码，并通过该哈希码计算出该元素应该存储在数组中的位置，也就是桶的位置。

## 1.1 存储元素的过程

- `HashMap` 存储元素时，会首先计算元素的哈希码。
- 然后根据哈希码计算出桶的位置，即数组中的索引位置。
- 将元素存储到对应的桶中。如果该桶已经有元素（发生了哈希冲突），则多个元素会通过链表或红黑树的形式存储在同一个桶中。

## 1.2 哈希冲突

哈希码相同时会发生哈希冲突，因为它们会存储在同一个桶中。由于数组的每个项只能存储一个元素，发生哈希冲突时，后来的元素会被链接到当前元素后面，形成一个链表结构。如果链表长度过长，`HashMap` 会将链表转换为红黑树，以提高性能。



# 2 hashCode()与equals()

在 `HashMap` 中存储的是键值对，但 **只有 `key` 参与哈希计算**， `key` 来决定该键值对存储在哪个桶。发生哈希冲突时，`HashMap` 会通过 `key` 的 `equals()` 方法来判断两个键是否相等。

## 2.1 hashCode()

- `hashCode()` 是 `Object` 类的方法，用于生成对象的哈希码。
- 在未重写 `hashCode()` 方法时，哈希码默认与对象的**内存地址相关**，两个对象**即使属性相同**，若它们的**内存地址不同**，**哈希码也不同**。
- 重写 `hashCode()` 方法时，哈希码的计算将**基于**对象的**属性值**，这样**相同属性**值的对象将具有**相同的哈希码**。

## 2.2 equals()方法

- `equals()` 用于比较两个对象是否相等。**默认**情况下，`equals()` 方法**比较**的是对象的**内存地址**。
- 如果重写了 `equals()` 方法，通常会**根据**对象的**属性值**来**判断**两个对象**是否相等**。

## 2.3 重写hashCode()和equals()的重要性

一般来说，重写 `equals()` 方法时，应该同时重写 `hashCode()` 方法。因为在 `HashMap` 中，哈希码决定了元素存储的桶位置，而 `equals()` 用来判断同一个桶中的元素是否相等。

### 2.3.1 未重写hashCode()的问题

如果只重写了 `equals()` 方法而未重写 `hashCode()` 方法，可能会遇到以下问题：

```java
Person person1 = new Person("Alice", 25);
Person person2 = new Person("Alice", 25);
map.put(person1, "First");
map.get(person2); // 返回 null
```

- `person1` 和 `person2` 的属性值相同，因此它们在逻辑上是相等的。
- 但由于没有重写 `hashCode()`，这两个对象的哈希码基于内存地址计算，导致它们的哈希码不同。
- 当使用 `person1` 存入 `HashMap` 时，它被存储在某个桶中。
- 当用 `person2` 查找时，`HashMap` 计算出的哈希码与 `person1` 不同，导致查找失败，返回 `null`。

### 2.3.2 重写hashCode()的好处

重写 `hashCode()` 方法的目的是为了确保相同的键能够被存储在相同的桶中，而不是发生哈希冲突时存储在不同的桶中。这确保了在使用自定义对象作为 `key` 时，能够正确地根据 `key` 查找到对应的值。

### 2.3.3 重写equals()的好处

重写 `equals()` 方法是为了确保在同一个桶中能够正确地判断对象是否相等。如果没有重写 `equals()` 方法，两个属性值相同的对象可能会被认为不相等，从而无法正确取出对应的值。



# 3 总结

- `HashMap` 存储键值对时，首先通过 `key` 的 `hashCode()` 方法定位到桶位置。
- 如果只重写了 `equals()` 方法，而没有重写 `hashCode()`，逻辑上相等的对象可能会存储在不同的桶中，导致查找失败。
- 如果只重写了 `hashCode()` 方法，而没有重写 `equals()`，即使两个对象属性相同，`equals()` 也会返回 `false`，导致查找失败。
- 正确的做法是同时重写 `hashCode()` 和 `equals()` 方法，以确保 `HashMap` 的正确行为。
  - 简单来说就是从哈希表中取出值需要达成两个关键点：**找到元素所在桶的位置** 和 **找到桶中的元素**，重写`hashCode()` 能保证找到元素桶的位置，重写`equals()`能保证找到桶中的元素。